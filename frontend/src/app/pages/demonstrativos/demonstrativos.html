<div class="board">
  <!-- Sidebar -->
  <aside class="sidebar d-flex flex-column p-3">
    <h2 class="fw-bold text-white mb-4">MONEVA</h2>
    <ul class="nav flex-column">
      <li class="nav-item mb-2"><a class="nav-link text-white" routerLink="/home">üè† Home</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-white" routerLink="/trilha">üí∞ Trilha de Aprendizado</a></li>
      <li class="nav-item mb-2"><a class="nav-link aside text-white active" routerLink="/demonstrativos">üìä Demonstrativos</a></li>
      <li class="nav-item"><a class="nav-link text-white" routerLink="/conquistas">üèÜ Conquistas</a></li>
    </ul>
  </aside>

  <!-- Conte√∫do -->
  <main class="main">
    <!-- Topbar -->
    <header class="topbar">
      <div class="brand">
        <div class="logo">Moneva</div>
        <small class="muted">Todas as contas</small>
      </div>

      <div class="month-nav">
        <button class="icon-btn" (click)="mudarMes(-1)"><i class="bi bi-chevron-left"></i></button>
        <span class="month">{{ nomeMes() }}</span>
        <button class="icon-btn" (click)="mudarMes(1)"><i class="bi bi-chevron-right"></i></button>
      </div>

      <div class="actions">
        <button class="icon-btn" (click)="abrirFiltro()"><i class="bi bi-funnel"></i></button>
        <button class="icon-btn" (click)="abrirBusca()"><i class="bi bi-search"></i></button>
        <div class="menu-wrap">
          <button class="icon-btn" (click)="abrirMenu()"><i class="bi bi-three-dots-vertical"></i></button>
          @if (showMenu()) {
            <div class="menu-card">
              <button class="menu-item" (click)="setTheme('dark')">Tema escuro</button>
              <button class="menu-item" (click)="setTheme('light')">Tema claro</button>
              <button class="menu-item" (click)="setTheme('')">Tema padr√£o</button>
              <hr>
              <button class="menu-item danger" (click)="abrirLixeira()">Abrir lixeira</button>
            </div>
          }
        </div>
      </div>
    </header>

    <!-- Gr√°fico -->
    <section class="ring-area">
      <div class="ring-wrap">
        <canvas id="ringChart"></canvas>
        <div class="ring-center">
          <div class="in-label">R$ {{ totalEntradas() | number:'1.2-2' }}</div>
          <div class="out-label">R$ {{ totalSaidas() | number:'1.2-2' }}</div>
        </div>

        <div class="orbit">
          @for (g of gastosPorCategoria(); track g.nome; let i = $index) {
            <div class="bubble" [style.--i]="i" [style.--n]="gastosPorCategoria().length">
              <span class="pct">{{ g.pct }}%</span>
              <span class="emoji">{{ g.emoji }}</span>
            </div>
          }
        </div>
      </div>
    </section>

    <!-- Saldo + bot√µes fixos -->
    <section class="saldo-bar">
      <div class="saldo-row">
        <button class="mini-fab minus" (click)="abrirAdd('saida')">‚àí</button>

        <div class="saldo-chip">
          <span>Saldo</span>
          <strong>R$ {{ saldo() | number:'1.2-2' }}</strong>
        </div>

        <button class="mini-fab plus" (click)="abrirAdd('entrada')">+</button>
      </div>
    </section>

    <!-- Lista -->
    <section class="history">
      @for (t of filtered(); track t.id) {
        <div class="rowi">
          <div class="left">
            <div class="cat">{{ t.categoria }}</div>
            <small class="muted">{{ (t.meio | titlecase) }} ‚Ä¢ {{ t.date.toDate() | date:'dd/MM' }}</small>
            <small class="muted" *ngIf="t.obs">‚Äî {{ t.obs }}</small>
          </div>
          <div class="right" [class.in]="t.tipo==='entrada'" [class.out]="t.tipo==='saida'">
            {{ t.tipo==='entrada' ? '+' : '-' }} R$ {{ t.valor | number:'1.2-2' }}
          </div>
          <button class="trash" (click)="confirmarExcluir(t.id!)"><i class="bi bi-trash"></i></button>
        </div>
      }
    </section>

    <!-- FAB inteligentes: aparecem quando o saldo sai de vista -->
    <div class="fab-smart">
      <button class="fab small plus" (click)="abrirAdd('entrada')">+</button>
      <button class="fab small minus" (click)="abrirAdd('saida')">‚àí</button>
    </div>
  </main>
</div>

<!-- Modal Adicionar -->
@if (showAdd()) {
  <div class="modal">
    <div class="modal-card">
      <h5 class="mb-2 text-white">{{ novo.tipo==='entrada' ? 'Nova Entrada' : 'Nova Despesa' }}</h5>

      <div class="grid">
        <label>Data
          <input type="date" [value]="dateToInput(novo.date)" (change)="onDateChange($event)" />
        </label>
        <label>Meio
          <select [(ngModel)]="novo.meio">
            <option value="pix">PIX</option><option value="dinheiro">Dinheiro</option>
            <option value="debito">D√©bito</option><option value="credito">Cr√©dito</option>
            <option value="boleto">Boleto</option><option value="outro">Outro</option>
          </select>
        </label>
        <label>Categoria
          <select [(ngModel)]="novo.categoria">
            @for (c of categorias; track c.nome) { <option [value]="c.nome">{{ c.emoji }} {{ c.nome }}</option> }
          </select>
        </label>
        <label>Valor (R$)
          <input type="number" step="0.01" min="0" [(ngModel)]="novo.valor" />
        </label>
        <label class="full">Observa√ß√£o
          <input type="text" [(ngModel)]="novo.obs" />
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" (click)="fecharAdd()">Cancelar</button>
        <button class="btn solid" (click)="salvarTransacao()">Salvar</button>
      </div>
    </div>
  </div>
}

<!-- Modal Confirma√ß√£o -->
@if (showConfirm().open) {
  <div class="modal">
    <div class="modal-card confirm">
      <h5 class="mb-3">Confirmar exclus√£o</h5>
      <p class="text-white">Deseja realmente enviar esta movimenta√ß√£o para a lixeira?</p>
      <div class="modal-actions">
        <button class="btn ghost" (click)="cancelarExcluir()">Cancelar</button>
        <button class="btn danger" (click)="excluirConfirmado()">Excluir</button>
      </div>
    </div>
  </div>
}

<!-- Modal Filtro -->
@if (showFilter()) {
  <div class="modal" (click)="fecharFiltro()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <h5 class="mb-2">Filtros</h5>
      <div class="grid">
        <label>Tipo
          <select [ngModel]="filtro().tipo" (ngModelChange)="updateFiltro('tipo', $event)">
            <option value="todas">Todas</option>
            <option value="entrada">Entradas</option>
            <option value="saida">Despesas</option>
          </select>
        </label>
        <label>Meio
          <select [ngModel]="filtro().meio" (ngModelChange)="updateFiltro('meio', $event)">
            <option value="todos">Todos</option>
            <option value="pix">PIX</option><option value="dinheiro">Dinheiro</option>
            <option value="debito">D√©bito</option><option value="credito">Cr√©dito</option>
            <option value="boleto">Boleto</option><option value="outro">Outro</option>
          </select>
        </label>
        <label>Categoria
          <select [ngModel]="filtro().categoria" (ngModelChange)="updateFiltro('categoria', $event)">
            <option value="todas">Todas</option>
            @for (c of categorias; track c.nome) { <option [value]="c.nome">{{ c.nome }}</option> }
          </select>
        </label>
        <label>De
          <input type="date" [ngModel]="filtro().start" (ngModelChange)="updateFiltro('start', $event)" />
        </label>
        <label>At√©
          <input type="date" [ngModel]="filtro().end" (ngModelChange)="updateFiltro('end', $event)" />
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" (click)="fecharFiltro()">Fechar</button>
      </div>
    </div>
  </div>
}

<!-- Modal Busca -->
@if (showSearch()) {
  <div class="modal" (click)="fecharBusca()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <h5 class="mb-2">Buscar</h5>
      <div class="grid">
        <label class="full">Texto na observa√ß√£o
          <input type="text" [ngModel]="filtro().q" (ngModelChange)="updateFiltro('q', $event)" />
        </label>
        <label>Valor igual a (R$)
          <input type="number" step="0.01" [ngModel]="filtro().valor"
                 (ngModelChange)="onValorChange($event)" />
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" (click)="fecharBusca()">Fechar</button>
      </div>
    </div>
  </div>
}

<!-- Modal Lixeira (placeholder estilizado; substitua por um componente quando quiser) -->
@if (showTrash()) {
  <div class="modal" (click)="fecharLixeira()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <h5 class="mb-2">Lixeira</h5>
      @if (trashLoading()) {
        <p class="text-white">Carregando...</p>
      } @else {
        @if (trash().length === 0) {
          <p class="text-white">Nenhum item na lixeira.</p>
        } @else {
          <div class="history">
            @for (t of trash(); track t.id) {
              <div class="rowi">
                <div class="left">
                  <div class="cat">{{ t.categoria }}</div>
                  <small class="muted">
                    {{ (t.meio | titlecase) }} ‚Ä¢ {{ t.date.toDate() | date:'dd/MM' }}
                  </small>
                  <small class="muted" *ngIf="t.obs">‚Äî {{ t.obs }}</small>
                </div>
                <div class="right" [class.in]="t.tipo==='entrada'" [class.out]="t.tipo==='saida'">
                  {{ t.tipo==='entrada' ? '+' : '-' }} R$ {{ t.valor | number:'1.2-2' }}
                </div>
                <button class="trash" (click)="restaurar(t)">
                  <i class="bi bi-arrow-counterclockwise"></i>
                </button>
              </div>
            }
          </div>
        }
      }
      <div class="modal-actions">
        <button class="btn ghost" (click)="fecharLixeira()">Fechar</button>
      </div>
    </div>
  </div>
}
